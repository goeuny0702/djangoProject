{% load static %}
<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <title>이력서 작성</title>
  <link rel="stylesheet" href="{% static 'main.css' %}">
</head>

<body>
  <div class="mycontainer">
    <div class="namecontainer">
      <h1>{{ user.username }}님 환영합니다 ♡</h1>
    </div>
    <div class="logoutcontainer">
      <div class="logoutbtn"><a href="{% url 'logout' %}">로그아웃</a></div>
    </div>
    <div class="sidebar">
      <div class="resume-management">이력서 관리</div>
      <div class="resume-list">
        {% for resume in resumes %}
          <div class="resume-item" style="position: relative; padding: 5px;" onmouseenter="this.querySelector('.delete-btn').style.display='inline'" onmouseleave="this.querySelector('.delete-btn').style.display='none'">
            <span onclick="loadResumeFromServer('{{ resume.id }}')" style="cursor: pointer;">
              {{ resume.title }}
            </span>
            <button class="delete-btn" onclick="deleteResume('{{ resume.id }}')" style="position: absolute; right: 0; top: 50%; transform: translateY(-50%); display: none; background: #f8d7da; border: none; color: #721c24; padding: 2px 6px; border-radius: 4px; cursor: pointer;">삭제</button>
          </div>
        {% empty %}
          <p>작성한 이력서가 없습니다.</p>
        {% endfor %}
    </div>
  </div>
  
    

  </div>
  <div class="main">
    <div style="display: flex; justify-content: center;">
      <input type="text" placeholder="이력서 제목" class="input-title" id="resume-title" name="title"><br>
    </div>
    <div class="inputgroup"
      style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
      <div class="profile-image" style="width: 20%; height: 200px; background-color: #f8d7da;"></div>
      <div class="personal-info" style="width: 70%;">
        <input type="text" placeholder="이름" class="text_input_main" id="name">
        <input type="text" placeholder="성별" class="text_input_main" id="gender">
        <input type="text" placeholder="생년월일" class="text_input_main" id="birthdate"><br><br>
        <input type="email" placeholder="이메일" class="text_input_main" id="email">
        <input type="text" placeholder="휴대폰" class="text_input_main" id="phone"><br><br>
        <input type="text" placeholder="주소" class="text_input_main" id="address">
        <input type="text" placeholder="상세주소" class="text_input_main" id="detail-address">
      </div>
    </div>


    <!--학력-->
    <div class="section" id="education-section" style="display: none;">
      <div class="section-header"
        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
        <div class="section-title">학력</div>
        <button class="addbtn" onclick="showEducationForm()">+추가</button>
      </div>
      <div id="education-list"></div>
    </div>
    <div id="education-form-template" style="display: none;">
      <div class="education-entry" style="margin: 5px;">
        <!-- 저장 결과를 보여줄 영역 -->
        <div class="education-summary" style="display: none;"></div>
        <input type="text" placeholder="학교명" class="text_input">
        <select class="text_input" id="education-select">
          <option>졸업</option>
          <option>재학중</option>
          <option>휴학중</option>
        </select>
        <input type="date" placeholder="입학년도" class="text_input datepicker">
        <input type="date" placeholder="졸업년도" class="text_input datepicker"><br>
        <input type="text" placeholder="전공" class="text_input">
        <input type="text" placeholder="학점" class="text_input">
        <div class="form-buttons">
          <button onclick="removeEducationForm(this)" class="cencle_save_btn">취소</button>
          <button onclick="saveEducation(this)" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <!--경력-->
    <div class="section" id="career-section" style="display: none;">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="section-title">경력</div>
        <button class="addbtn" onclick="showCareerForm()">+추가</button>
      </div>
      <div id="career-list"></div>
    </div>
    <div id="career-form-template" style="display: none;">
      <div class="career-entry">
        <!-- 저장 결과 표시 -->
        <div class="career-summary" style="display: none;"></div>

        <input type="text" placeholder="회사명" class="text_input">
        <input type="date" placeholder="입사년월" class="text_input datepicker">
        <input type="date" placeholder="퇴사년월" class="text_input datepicker"><br>
        <input type="text" placeholder="직무" class="text_input">
        <input type="text" placeholder="근무부서" class="text_input">
        <input type="text" placeholder="직급" class="text_input"><br>
        <textarea placeholder="담당업무" class="longtext"></textarea>

        <div class="form-buttons">
          <button onclick="removeCareerForm(this)" class="cencle_save_btn">취소</button>
          <button onclick="saveCareer(this)" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <!-- 스킬 -->
    <div class="section" id="skill-section" style="display: none;">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="section-title">스킬</div>
        <button class="addbtn" onclick="showskill()">+추가</button>
      </div>
      <div id="skill-list" style="margin: 10px 0;"></div>

      <div id="skill-form" style="display: none;">
        <div class="skill-search">
          <input type="text" id="skillSearch" placeholder="기술 검색..." onkeyup="searchSkills()" autocomplete="off">
          <div id="skillSuggestions" class="suggestions" style="border: 1px solid #ccc; display: none;"></div>
        </div>
        <div class="form-buttons">
          <button onclick="cancelskill()" class="cencle_save_btn">취소</button>
          <button onclick="saveskill()" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <!-- 경험/활동/교육 -->
    <div class="section" id="experience-section" style="display: none;">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="section-title">경험/활동/교육</div>
        <button class="addbtn" onclick="showExperienceForm()">+추가</button>
      </div>
      <div id="experience-list"></div>
    </div>
    <!-- 경험 템플릿 -->
    <div id="experience-form-template" style="display: none;">
      <div class="experience-entry">
        <div class="experience-summary" style="display: none;"></div>

        <select class="text_input">
          <option value="">활동 유형 선택</option>
          <option value="campus">교내활동</option>
          <option value="volunteer">자원봉사</option>
          <option value="intern">인턴</option>
          <option value="club">동아리</option>
          <option value="parttime">아르바이트</option>
          <option value="social">사회활동</option>
          <option value="project">수행과제</option>
          <option value="overseas">해외연수</option>
          <option value="education">교육이수내역</option>
        </select>
        <input type="text" placeholder="기관/장소명" class="text_input"><br>
        <input type="date" placeholder="시작년월" class="text_input datepicker">
        <input type="date" placeholder="종료년월" class="text_input datepicker"><br>
        <textarea placeholder="활동 설명" class="longtext"></textarea>

        <div class="form-buttons">
          <button onclick="removeExperienceForm(this)" class="cencle_save_btn">취소</button>
          <button onclick="saveExperience(this)" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <!-- ================= 자격/어학/수상 ================= -->
    <div class="section" id="certificate-section" style="display:none;">
      <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;">
        <div class="section-title">자격/어학/수상</div>
        <button class="addbtn" onclick="showcertificate(false)">+추가</button>
      </div>

      <!-- 저장된 카드가 쌓이는 곳 -->
      <div id="certificate-list"></div>

      <!-- 입력 폼 -->
      <div id="certificate-form" style="display:none;">
        <select id="certificateType" class="text_input" onchange="showCertificateFields()">
          <option value="">구분 선택</option>
          <option value="license">자격증</option>
          <option value="language">어학</option>
          <option value="award">수상</option>
        </select>

        <!-- 자격증 -->
        <div id="licenseFields" class="cert-fields" style="display:none;">
          <input name="license_name" type="text" placeholder="자격증명" class="text_input">
          <input name="issuer" type="text" placeholder="발행처" class="text_input">
          <input name="pass_date" type="month" class="text_input" placeholder="합격년월">
        </div>

        <!-- 어학 -->
        <div id="languageFields" class="cert-fields" style="display:none;">
          <select name="lang" class="text_input">
            <option>영어</option>
            <option>일본어</option>
            <option>중국어</option>
          </select>
          <input name="exam" type="text" placeholder="어학시험명" class="text_input">
          <input name="score" type="text" placeholder="급수/점수" class="text_input">
          <select name="status" class="text_input">
            <option>취득</option>
            <option>미취득</option>
          </select>
        </div>

        <!-- 수상 -->
        <div id="awardFields" class="cert-fields" style="display:none;">
          <input name="award_name" type="text" placeholder="수상/공모전명" class="text_input">
          <input name="award_date" type="date" class="text_input" placeholder="수상일">
          <input name="host" type="text" placeholder="수여/주최기관" class="text_input">
        </div>

        <div class="form-buttons">
          <button onclick="cancelcertificate()" class="cencle_save_btn">취소</button>
          <button onclick="savecertificate()" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <!-- ================= 취업우대사항 ================= -->
    <div class="section" id="preference-section" style="display:none;">
      <div class="section-header" style="display:flex;justify-content:space-between;align-items:center;">
        <div class="section-title">취업우대사항</div>
        <button class="addbtn" onclick="showPreference(false)">+추가</button>
      </div>

      <!-- 카드 리스트 -->
      <div id="preference-list"></div>

      <!-- 입력 폼 -->
      <div id="preference-form" style="display:none;">
        <select id="preferenceType" class="text_input" onchange="showPreferenceFields()">
          <option value="">구분 선택</option>
          <option value="veteran">보훈대상</option>
          <option value="military">병역대상</option>
          <option value="employment">고용지원금</option>
        </select>

        <!-- 보훈 -->
        <div id="veteranFields" class="pref-fields" style="display:none;">
          <select name="v_type" class="text_input">
            <option>국가유공자</option><option>보훈대상자</option>
          </select>
          <input name="v_cert" type="text" placeholder="증명서 번호" class="text_input">
        </div>

        <!-- 병역 -->
        <div id="militaryFields" class="pref-fields" style="display:none;">
          <select name="m_status" id="mStatus" class="text_input" onchange="toggleMilitaryDetail()">
            <option value="">병역구분</option>
            <option value="served">군필</option>
            <option value="exempt">면제</option>
            <option value="unserved">미필</option>
          </select>

          <div id="servedDetail" style="display:none;">
            <input  name="m_start" type="month" class="text_input" placeholder="입대 YYYY-MM" min="1950-01" max="2100-12">
            <input  name="m_end"   type="month" class="text_input" placeholder="전역 YYYY-MM" min="1950-01" max="2100-12">
            <select name="m_branch" class="text_input">
              <option>육군</option><option>해군</option><option>공군</option>
              <option>해병</option><option>의경</option><option>사회복무요원</option>
            </select>
            <select name="m_rank" class="text_input">
              <option>이병</option><option>일병</option><option>상병</option><option>병장</option>
              <option>하사</option><option>중사</option><option>상사</option><option>원사</option>
              <option>준위</option><option>소위</option><option>중위</option><option>대위</option>
              <option>소령</option><option>중령</option><option>대령</option>
              <option>준장</option><option>소장</option><option>중장</option><option>대장</option>
            </select>
            <select name="m_reason" class="text_input">
              <option>만기전역</option><option>의가사전역</option><option>의병전역</option>
              <option>소집해제</option><option>불명예전역</option><option>상이전역</option>
            </select>
          </div>
        </div>

        <!-- 고용지원금 -->
        <div id="employmentFields" class="pref-fields" style="display:none;">
          <select name="e_type" class="text_input">
            <option>청년고용지원금</option><option>장애인고용지원금</option>
          </select>
        </div>

        <div class="form-buttons">
          <button onclick="cancelPreference()" class="cencle_save_btn">취소</button>
          <button onclick="savePreference()"   class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <!-- 포트폴리오 -->
    <div class="section" id="portfolio-section" style="display: none;">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="section-title">포트폴리오</div>
        <button class="addbtn" onclick="showPortfolioForm()">+추가</button>
      </div>
      <div id="portfolio-list"></div>
    </div>

    <!-- 포트폴리오 템플릿 -->
    <div id="portfolio-form-template" style="display: none;">
      <div class="portfolio-entry">
        <div class="portfolio-summary" style="display: none;"></div>

        <input type="text" placeholder="프로젝트명" class="text_input"><br>
        <textarea placeholder="프로젝트 설명" class="longtext"></textarea>
        <input type="file" multiple class="text_input file-input">

        <div class="form-buttons">
          <button onclick="removePortfolioForm(this)" class="cencle_save_btn">취소</button>
          <button onclick="savePortfolio(this)" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <!--경력기술서-->
    <div class="section" id="career-description-section" style="display: none;">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="section-title">경력기술서</div>
        <button class="addbtn" onclick="showdescription()">+추가</button>
      </div>

      <div id="career-description-list"></div>

      <!-- 입력 폼 -->
      <div id="career-description-form" style="display: none;">
        <textarea id="careerDescriptionText" class="longtext" placeholder="경력기술서 내용을 입력하세요..."
          oninput="updateCharCount()" style="width: 100%; height: 200px; font-size: 16px;"></textarea>
          
        <div style="margin-top: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
          <div>
            <button class="type-tab" onclick="insertTemplate('project')">프로젝트형</button>
            <button class="type-tab" onclick="insertTemplate('dev')">개발 기술형</button>
            <button class="type-tab" onclick="insertTemplate('design')">디자이너형</button>
            <button class="type-tab" onclick="insertTemplate('sales')">영업 성과형</button>
          </div>
          <div style="color: #999; font-size: 14px;">
            총 글자수 <span id="totalChars">0</span>자 / <span id="totalBytes">0</span> byte
          </div>
        </div>

        <div style="margin-top: 10px; text-align: right;">
          <button onclick="canceldescription()" class="cencle_save_btn">취소</button>
          <button onclick="savedescription()" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>


    <!--자기소개서-->
    <div class="section" id="introduction-section" style="display: none;">
      <div class="section-header" style="display: flex; justify-content: space-between; align-items: center;">
        <div class="section-title">자기소개서</div>
        <button class="addbtn" onclick="showintroduction()">+추가</button>
      </div>
      <div id="introduction-list"></div>
      <div id="introduction-form" style="display: none;">
        <div style="display: flex; align-items: center; margin: 5px; width: 100%; height: 8%;">
          <input type="text" placeholder="제목" style="flex-grow: 1; font-size: 30px;">
          <button onclick="showTitleSuggestions()" style="font-size: 24px;">추천제목예시</button>
        </div>
        <div id="titleSuggestions" style="display: none;">
          <ul>
            <li onclick="selectTitle('성장과정')">성장과정</li>
            <li onclick="selectTitle('지원동기')">지원동기</li>
            <li onclick="selectTitle('입사 후 포부')">입사 후 포부</li>
          </ul>
        </div>
        <input placeholder="내용" class="longtext"></input>
        <div class="form-buttons">
          <button onclick="cancelintroduction()" class="cencle_save_btn">취소</button>
          <button onclick="saveintroduction()" class="cencle_save_btn">저장</button>
        </div>
      </div>
    </div>

    <div class="right-panel">
      <div class="right-panel-move">
        <div class="right-panel-title">
          <strong>My Career</strong>
        </div>
        <div class="checkbox-group">
          <div class="checkboxtext">
            <span>학력</span>
            <input type="checkbox" onchange="toggleSection('education-section')">
          </div>
          <div class="checkboxtext">
            <span>경력</span>
            <input type="checkbox" onchange="toggleSection('career-section')">
          </div>
          <div class="checkboxtext">
            <span>스킬</span>
            <input type="checkbox" onchange="toggleSection('skill-section')">
          </div>
          <div class="checkboxtext">
            <span>경험/활동/교육</span>
            <input type="checkbox" onchange="toggleSection('experience-section')">
          </div>
          <div class="checkboxtext">
            <span>자격/어학/수상</span>
            <input type="checkbox" onchange="toggleSection('certificate-section')">
          </div>
          <div class="checkboxtext">
            <span>취업우대사항</span>
            <input type="checkbox" onchange="toggleSection('preference-section')">
          </div>
          <div class="checkboxtext">
            <span>포트폴리오</span>
            <input type="checkbox" onchange="toggleSection('portfolio-section')">
          </div>
          <div class="checkboxtext">
            <span>경력기술서</span>
            <input type="checkbox" onchange="toggleSection('career-description-section')">
          </div>
          <div class="checkboxtext">
            <span>자기소개서</span>
            <input type="checkbox" onchange="toggleSection('introduction-section')">
          </div>
        </div>

        <button class="endbtn">이력서 미리보기</button><br>
        <input type="hidden" id="sections-json">
        <button class="endbtn" onclick="saveResume(event)">작성완료</button>

      </div>
    </div>


    <script>
      const loggedInUserId = "{{ request.user.username }}";

       // 사용할 스킬 목록
      const availableSkills = [
      "Python", "Java", "C", "C++", "C#", "JavaScript", "TypeScript", "Go", "Kotlin", "Swift", "Ruby", "PHP", "Rust", "Scala",
      "HTML", "CSS", "React", "Vue.js", "Angular", "Next.js", "Svelte", "Tailwind CSS", "Bootstrap", "jQuery",
      "Django", "Flask", "Spring", "Spring Boot", "Node.js", "Express", "FastAPI", "NestJS", "Ruby on Rails", "ASP.NET",
      "MySQL", "PostgreSQL", "SQLite", "MongoDB", "Firebase", "Oracle", "AWS", "Azure", "Google Cloud", "Docker", "Kubernetes",
      "Git", "GitHub", "Linux", "VS Code", "Jenkins", "Notion", "Figma", "TensorFlow", "PyTorch", "OpenCV", "Unity", "Unreal Engine"
      ];


      // 선택된 스킬 저장 배열
      let selectedSkills = [];

      function saveResume(event) {
        event.preventDefault();  // form 동작 방지

        const title = document.getElementById('resume-title').value;
        const name = document.getElementById('name').value;
        const gender = document.getElementById('gender').value;
        const birthdate = document.getElementById('birthdate').value;
        const email = document.getElementById('email').value;
        const phone = document.getElementById('phone').value;
        const address = document.getElementById('address').value;
        const detailAddress = document.getElementById('detail-address').value;

        const sections = {
          education: collectEducationData() || [],
          career: collectCareerData() || [],
          experience: collectExperienceData() || [],
          certificate: collectCertificateData() || [],
          preference: collectPreferenceData() || [],
          portfolio: collectPortfolioData() || [],
          description: collectCareerDescriptionData() || [],
          introduction: collectIntroductionData() || [],
          skills: selectedSkills || []
        };

        document.getElementById("sections-json").value = JSON.stringify(sections);
        console.log("sections-json 값:", document.getElementById("sections-json").value);

        const resumeData = {
          title: title,
          name: name,
          gender: gender,
          birthdate: birthdate,
          email: email,
          phone: phone,
          address: address,
          'detail-address': detailAddress,
          sections_json: JSON.stringify(sections)
        };

        fetch('/save_resume/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCookie('csrftoken')
          },
          body: new URLSearchParams(resumeData)
        })
        .then(response => {
          if (response.redirected) {
            window.location.href = response.url;
          } else if (response.ok) {
            alert("이력서 저장 완료!");
          } else {
            return response.text().then(text => {
              console.error(text);
              alert("저장 실패: " + text);
            });
          }
        })
        .catch(error => {
          console.error("에러 발생:", error);
          alert("서버 요청 중 오류가 발생했어요.");
        });
    }


      




      function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      }




      function addToResumeList(title) {
        const listDiv = document.querySelector('.resume-list');
        const newItem = document.createElement('div');
        newItem.textContent = title;
        newItem.onclick = () => loadResume(title);
        listDiv.appendChild(newItem);
      }

      function loadResume(title) {
        const resumes = JSON.parse(localStorage.getItem('resumeList')) || [];
        const resume = resumes.find(r => r.basicInfo.title === title);
        if (!resume) return;

        document.getElementById('resume-title').value = resume.basicInfo.title;
        document.getElementById('name').value = resume.basicInfo.name;
        document.getElementById('gender').value = resume.basicInfo.gender;
        document.getElementById('birthdate').value = resume.basicInfo.birthdate;
        document.getElementById('email').value = resume.basicInfo.email;
        document.getElementById('phone').value = resume.basicInfo.phone;
        document.getElementById('address').value = resume.basicInfo.address;
        document.getElementById('detail-address').value = resume.basicInfo.detailAddress;

        selectedSkills = resume.skills;

        // 만약 배열이 아니면 빈 배열로 강제
        if (!Array.isArray(selectedSkills)) {
          if (typeof selectedSkills === 'string') {
            try {
              selectedSkills = JSON.parse(selectedSkills);
              if (!Array.isArray(selectedSkills)) selectedSkills = [];
            } catch (e) {
              selectedSkills = [];
            }
          } else {
            selectedSkills = [];
          }
        }

        updateSkillList();

      }

    function loadResumeFromServer(resumeId) {
      fetch(`/get_resume/${resumeId}/`)
        .then(response => {
          if (!response.ok) throw new Error('이력서 불러오기 실패');
          return response.json();
        })
        .then(data => {
          console.log("data 확인:", data); // 서버에서 내려온 전체 데이터 확인

          const resume = data.content;
          if (!resume) {
            alert("이력서 데이터가 없습니다.");
            return;
          }

          // 1. 기본 정보
          document.getElementById('resume-title').value = data.title || '';
          document.getElementById('name').value = resume.name || '';
          document.getElementById('gender').value = resume.gender || '';
          document.getElementById('birthdate').value = resume.birthdate || '';
          document.getElementById('email').value = resume.email || '';
          document.getElementById('phone').value = resume.phone || '';
          document.getElementById('address').value = resume.address || '';
          document.getElementById('detail-address').value = resume.detail_address || '';

          // 2. sections > skills
          // 구조를 다시 한 번 콘솔로 체크 (꼭!)
          console.log("resume.sections:", resume.sections);
          selectedSkills = (resume.sections && Array.isArray(resume.sections.skills)) ? resume.sections.skills : [];
          console.log("불러온 selectedSkills:", selectedSkills);

          updateSkillList();

        })
        .catch(error => {
          alert('이력서 불러오기 실패: ' + error.message);
        });
    }





    function deleteResume(resumeId) {
      if (!confirm("정말 이 이력서를 삭제하시겠습니까?")) return;

      fetch(`/resume/delete/${resumeId}/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken')
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("이력서가 삭제되었습니다.");
          location.reload();
        } else {
          alert("삭제 실패");
        }
      })
      .catch(error => {
        console.error("삭제 오류:", error);
        alert("오류 발생");
      });
    }






      // 각 섹션별 데이터 수집 함수들
      function collectEducationData() {
        const summaries = document.querySelectorAll('.education-summary');

        return Array.from(summaries).map(summary => {
          const card = summary.querySelector('.education-card');
          if (!card) return null;

          const schoolText = card.querySelector('h4')?.textContent || '';
          const majorText = card.querySelector('p:nth-child(2)')?.textContent.replace('전공:', '').trim() || '';
          const gradeText = card.querySelector('p:nth-child(3)')?.textContent.replace('학점:', '').trim() || '';
          const graduationText = card.querySelector('p:nth-child(4)')?.textContent.split('삭제')[0].replace('졸업 구분:', '').trim() || '';

          return {
            school: schoolText,
            major: majorText,
            grade: gradeText,
            graduation: graduationText
          };
        }).filter(item => item !== null);
      }

      //경력
      function collectCareerData() {
        const careerEntries = document.querySelectorAll('.career-card');
        return Array.from(careerEntries).map(entry => {
          const companyText = entry.querySelector('h4').textContent;
          const positionText = entry.querySelector('p:nth-child(2)').textContent.replace('직무:', '').trim();
          const departmentText = entry.querySelector('p:nth-child(3)').textContent.replace('근무부서:', '').trim();
          const rankText = entry.querySelector('p:nth-child(4)').textContent.replace('직급:', '').trim();
          const dutiesText = entry.querySelector('p:nth-child(5)').textContent.replace('담당업무:', '').trim();

          // 회사명과 기간 분리
          const [company, period] = companyText.split(' (');
          const [startDate, endDate] = period.replace(')', '').split(' ~ ');

          return {
            company: company.trim(),
            startDate: startDate.trim(),
            endDate: endDate.trim(),
            position: positionText,
            department: departmentText,
            rank: rankText,
            duties: dutiesText
          };
        });
      }
      //경험/활동/교육
      function collectExperienceData() {
        const experienceEntries = document.querySelectorAll('.experience-card');
        return Array.from(experienceEntries).map(entry => {
          const activityText = entry.querySelector('h4').textContent;
          const descriptionText = entry.querySelector('p:nth-child(2)').textContent.replace('활동 설명:', '').trim();

          // 활동 유형, 기관/장소명, 기간 분리
          const [activityType, placeAndPeriod] = activityText.split(' - ');
          const [place, period] = placeAndPeriod.split(' (');
          const [startDate, endDate] = period.replace(')', '').split(' ~ ');

          return {
            activityType: activityType.trim(),
            place: place.trim(),
            startDate: startDate.trim(),
            endDate: endDate.trim(),
            description: descriptionText
          };
        });
      }
      //자격/어학/수상
      function collectCertificateData() {
        const certificateEntries = document.querySelectorAll('.cert-card');
        return Array.from(certificateEntries).map(entry => {
          const detailText = entry.querySelector('span').textContent;
          
          // 자격증, 어학, 수상 구분
          if (detailText.includes('[자격증]')) {
            const [_, info] = detailText.split('[자격증]');
            const [name, issuerAndDate] = info.split('·');
            const [issuer, date] = issuerAndDate.split('(');
            
            return {
              type: 'license',
              license_name: name.trim(),
              issuer: issuer.trim(),
              pass_date: date.replace(')', '').trim()
            };
          } else if (detailText.includes('[어학]')) {
            const [_, info] = detailText.split('[어학]');
            const [lang, exam, score, status] = info.split(' ');
            
            return {
              type: 'language',
              lang: lang.trim(),
              exam: exam.trim(),
              score: score.trim(),
              status: status.replace('(', '').replace(')', '').trim()
            };
          } else {
            const [_, info] = detailText.split('[수상]');
            const [name, hostAndDate] = info.split('·');
            const [host, date] = hostAndDate.split('(');
            
            return {
              type: 'award',
              award_name: name.trim(),
              host: host.trim(),
              award_date: date.replace(')', '').trim()
            };
          }
        });
      }
      //취업우대사항
      function collectPreferenceData() {
        const preferenceForm = document.getElementById('preference-form');
        return {
          content: preferenceForm.querySelector('input').value
        };
      }
      //포트폴리오
      function collectPortfolioData() {
        const portfolioEntries = document.querySelectorAll('.portfolio-card');
        return Array.from(portfolioEntries).map(entry => {
          const projectName = entry.querySelector('h4').textContent;
          const description = entry.querySelector('p:nth-child(2)').textContent.replace('설명:', '').trim();
          const filesText = entry.querySelector('p:nth-child(3)')?.textContent;
          const files = filesText ? filesText.replace('첨부파일:', '').trim() : '';
          
          // localStorage에 저장
          const portfolioData = {
            project: projectName,
            description: description,
            files: files
          };
          
          // 기존 데이터 가져오기
          let savedPortfolios = JSON.parse(localStorage.getItem('portfolios') || '[]');
          savedPortfolios.push(portfolioData);
          localStorage.setItem('portfolios', JSON.stringify(savedPortfolios));
          
          return portfolioData;
        });
      }
      //경력기술서
      function collectCareerDescriptionData() {
        const descriptionCards = document.querySelectorAll('.career-desc-card');
        const descriptions = Array.from(descriptionCards).map(card => {
          const content = card.querySelector('div').innerText;
          
          // localStorage에 저장
          const descriptionData = {
            content: content
          };
          
          // 기존 데이터 가져오기
          let savedDescriptions = JSON.parse(localStorage.getItem('careerDescriptions') || '[]');
          savedDescriptions.push(descriptionData);
          localStorage.setItem('careerDescriptions', JSON.stringify(savedDescriptions));
          
          return descriptionData;
        });
        
        return descriptions;
      }


      // 추가 버튼 누르면 검색창 보이기
      function showskill() {
        document.getElementById("skill-form").style.display = "block";
        document.getElementById("skillSearch").value = "";
        document.getElementById("skillSuggestions").innerHTML = "";
        document.getElementById("skillSuggestions").style.display = "none";
      }

      // 취소 버튼 누르면 검색창 숨기기
      function cancelskill() {
        document.getElementById("skill-form").style.display = "none";
        document.getElementById("skillSearch").value = "";
        document.getElementById("skillSuggestions").innerHTML = "";
        document.getElementById("skillSuggestions").style.display = "none";
      }

      // 저장 버튼 누르면 선택된 스킬 화면에 출력
      function saveskill() {
      updateSkillList();
      document.getElementById("skill-form").style.display = "none";
      }


      // 자동완성 검색
      function searchSkills() {
      const input = document.getElementById("skillSearch").value.toLowerCase();
      const suggestionsBox = document.getElementById("skillSuggestions");
      suggestionsBox.innerHTML = "";

      if (!input) {
        suggestionsBox.style.display = "none";
        return;
      }

      const matches = availableSkills.filter(skill =>
        skill.toLowerCase().includes(input) && !selectedSkills.includes(skill)
      );

      if (matches.length === 0) {
        suggestionsBox.style.display = "none";
        return;
      }

      suggestionsBox.style.display = "block";
      matches.forEach(skill => {
        const div = document.createElement("div");
        div.textContent = skill;
        div.style.padding = "5px";
        div.style.cursor = "pointer";
        div.style.borderBottom = "1px solid #eee";

        div.onclick = () => {
          selectedSkills.push(skill);
          document.getElementById("skillSearch").value = "";
          suggestionsBox.style.display = "none";

          // ✅ 리스트 실시간 업데이트
          const list = document.getElementById("skill-list");
          updateSkillList();
          searchSkills(); // 중복 제거용

        };

        suggestionsBox.appendChild(div);
      });
    }

    function updateSkillList() {
      const list = document.getElementById("skill-list");
      list.innerHTML = "";

      if (!Array.isArray(selectedSkills)) {
        try {
          selectedSkills = JSON.parse(selectedSkills);
          if (!Array.isArray(selectedSkills)) selectedSkills = [];
        } catch (e) {
          selectedSkills = [];
        }
      }

      selectedSkills.forEach((skill, index) => {
        const span = document.createElement("span");
        span.className = "skill-tag";
        span.style.position = "relative";
        span.style.display = "inline-block";
        span.style.marginRight = "10px";
        span.style.padding = "6px 24px 6px 10px";
        span.style.border = "3px solid #F5D1EA";
        span.style.borderRadius = "5px";
        span.style.backgroundColor = "none";
        span.style.cursor = "default";

        const skillText = document.createTextNode(`✔ ${skill}`);
        span.appendChild(skillText);

        const closeBtn = document.createElement("span");  // ✅ 선언 먼저!
        closeBtn.className = "delete-btn";
        closeBtn.textContent = "×";
        closeBtn.style.position = "absolute";
        closeBtn.style.right = "4px";
        closeBtn.style.top = "4px";
        closeBtn.style.fontSize = "14px";
        closeBtn.style.cursor = "pointer";
        closeBtn.style.color = "#ff4d4d";
        closeBtn.style.backgroundColor = "#fff";
        closeBtn.style.padding = "0 4px";
        closeBtn.style.borderRadius = "50%";
        closeBtn.style.border = "1px solid #ccc";
        closeBtn.style.display = "none"; // ❗ 선언 이후에 display 조작

        // 마우스 오버 시 보이기
        span.addEventListener("mouseenter", () => {
          closeBtn.style.display = "inline";
        });
        span.addEventListener("mouseleave", () => {
          closeBtn.style.display = "none";
        });

        closeBtn.onclick = () => {
          selectedSkills.splice(index, 1);
          updateSkillList();
        };

        span.appendChild(closeBtn);
        list.appendChild(span);
      });
    }







      //토글 
      function toggleSection(sectionId) {
        const section = document.getElementById(sectionId);
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
      }

      
      //학력 추가
      function showEducationForm() {

        const list = document.getElementById('education-list');

        // 입력란이 보이는 상태 = 아직 저장되지 않은 폼이 열려있다는 뜻
        const isFormOpen = Array.from(list.querySelectorAll('.education-entry')).some(entry => {
          const inputs = entry.querySelectorAll('input, textarea');
          return Array.from(inputs).some(input => input.style.display !== 'none');
        });

        if (isFormOpen) {
          return;
        }

        const template = document.getElementById("education-form-template").firstElementChild;
        const clone = template.cloneNode(true);
        clone.style.display = 'block';
        list.appendChild(clone);
      }
      //학력 삭제
      function removeEducationForm(button) {
        const entry = button.closest(".education-entry");
        if (entry) {
          entry.remove();
        }
      }
      // 학력 수정하기
      function editEducation(button) {
        const entry = button.closest(".education-entry");
        const summary = entry.querySelector(".education-summary");
        const inputs = entry.querySelectorAll("input, select");
        const formButtons = entry.querySelector(".form-buttons");

        // 요약 카드 숨기기
        summary.style.display = "none";

        // 입력 필드 다시 보이게
        inputs.forEach(input => input.style.display = "inline-block");

        // 기존 card-buttons 제거
        const cardButtons = summary.querySelector(".card-buttons");
        if (cardButtons) {
          cardButtons.remove();
        }

        // 저장/삭제 버튼 다시 생성
        if (formButtons) {
          formButtons.style.display = "flex";
          formButtons.style.justifyContent = "flex-end";
          formButtons.style.gap = "8px";
        }
      }
      //학력 저장 
      function saveEducation(button) {
        const entry = button.closest(".education-entry");
        const summary = entry.querySelector(".education-summary");
        const inputs = entry.querySelectorAll("input, select");
        const formButtons = entry.querySelector(".form-buttons");

        let values = {};

        inputs.forEach(input => {
          if (input.tagName.toLowerCase() === "select") {
            values["졸업구분"] = input.options[input.selectedIndex].text;
          } else {
            const key = input.placeholder || '선택';
            values[key] = input.value.trim();
          }
        });

        // 날짜 형식 검증
        const startDate = new Date(values['입학년도']);
        const endDate = new Date(values['졸업년도']);

        if (startDate > endDate) {
          alert('졸업년도는 입학년도보다 이후여야 합니다.');
          return;
        }

        // 필수 입력값 검증
        if (!values['학교명'] || !values['입학년도'] || !values['졸업년도'] || !values['전공'] || !values['학점']) {
          alert('학교명, 입학년도, 졸업년도는 필수 입력 항목입니다.');
          return;
        }

        function searchSkills() {
          const input = document.getElementById("skillSearch").value.toLowerCase();
          const suggestionsBox = document.getElementById("skillSuggestions");
          suggestionsBox.innerHTML = "";

          if (!input) {
            suggestionsBox.style.display = "none";
            return;
          }

          const matches = availableSkills.filter(skill =>
            skill.toLowerCase().includes(input) && !selectedSkills.includes(skill)
          );

          if (matches.length === 0) {
            suggestionsBox.style.display = "none";
            return;
          }

          suggestionsBox.style.display = "block";
          matches.forEach(skill => {
            const div = document.createElement("div");
            div.textContent = skill;
            div.style.padding = "5px";
            div.style.cursor = "pointer";
            div.onclick = () => {
              selectedSkills.push(skill);
              document.getElementById("skillSearch").value = "";
              suggestionsBox.style.display = "none";
              searchSkills(); // 다시 실행해서 새 목록 반영
            };
            suggestionsBox.appendChild(div);
          });
        }


        // 보기 카드 형태로 출력될 HTML 구성
        summary.innerHTML = `
          <div class="education-card">
            <h4>${values['학교명'] || ''} (${values['입학년도'] || ''} ~ ${values['졸업년도'] || ''})</h4>
            <p><strong>전공:</strong> ${values['전공'] || ''}</p>
            <p><strong>학점:</strong> ${values['학점'] || ''}</p>
            <p><strong>졸업 구분:</strong> ${values['졸업구분'] || ''}
              <button onclick="editEducation(this)" class="cencle_save_btn" style="float: right; margin-left: 8px;">수정</button>
              <button onclick="removeEducationForm(this)" class="cencle_save_btn" style="float: right;">삭제</button>
            </p>
          </div>
        `;


        // 입력 요소 숨기기
        inputs.forEach(input => input.style.display = "none");

        // 버튼 숨기기
        if (formButtons) {
          formButtons.style.display = "none";
        }

        // 요약 카드 보이기
        summary.style.display = "block";
      }

      //경력
      function showCareerForm() {

        const list = document.getElementById("career-list");

        // 현재 열려 있는 폼이 있는지 확인 (input/textarea가 보이는 상태)
        const isFormOpen = Array.from(list.querySelectorAll(".career-entry")).some(entry => {
          const inputs = entry.querySelectorAll("input, textarea");
          return Array.from(inputs).some(input => input.style.display !== "none");
        });

        if (isFormOpen) {
          return;
        }

        const template = document.getElementById("career-form-template").firstElementChild;
        const clone = template.cloneNode(true);
        clone.style.display = "block";
        list.appendChild(clone);
      }
      //경력 삭제
      function removeCareerForm(button) {
        const entry = button.closest(".career-entry");
        if (entry) {
          entry.remove();
        }
      }
      //경력 저장
      function saveCareer(button) {
        const entry = button.closest(".career-entry");
        const summary = entry.querySelector(".career-summary");

        // input과 textarea 모두 선택
        const inputs = entry.querySelectorAll("input, textarea");
        const values = {};

        // 입력값 수집
        inputs.forEach(input => {
          values[input.placeholder] = input.value;
        });

        // 필수 입력값 검증
        if (!values['회사명'] || !values['입사년월'] || !values['퇴사년월'] || !values['근무부서'] || !values['직무'] || !values['담당업무']) {
          alert('회사명, 입사년월, 퇴사년월, 근무부서, 직무, 담당업무는 필수 입력 항목입니다.');
          return;
        }

        // 날짜 형식 검증
        const startDate = new Date(values['입사년월']);
        const endDate = new Date(values['퇴사년월']);

        if (startDate > endDate) {
          alert('퇴사년월는 입사년월보다 이후여야 합니다.');
          return;
        }

        // HTML 템플릿 생성
        const careerCard = document.createElement('div');
        careerCard.className = 'career-card';
        careerCard.innerHTML = `
          <h4>${values['회사명'] || ''} (${values['입사년월'] || ''} ~ ${values['퇴사년월'] || ''})</h4>
          <p><strong>직무:</strong> ${values['직무'] || ''}</p>
          <p><strong>근무부서:</strong> ${values['근무부서'] || ''}</p>
          <p><strong>직급:</strong> ${values['직급'] || ''}</p>
          <p><strong>담당업무:</strong> ${values['담당업무'] || ''}</p>
          <div class="card-buttons" style="display: flex; justify-content: flex-end; gap: 8px;">
            <button onclick="editCareer(this)" class="cencle_save_btn">수정</button>
            <button onclick="removeCareerForm(this)" class="cencle_save_btn">삭제</button>
          </div>
        `;

        // 기존 내용 지우고 새로운 카드 추가
        summary.innerHTML = '';
        summary.appendChild(careerCard);

        // 입력 요소 숨기기
        inputs.forEach(input => input.style.display = "none");

        // 저장/취소 버튼 숨기기
        const formButtons = entry.querySelector(".form-buttons");
        if (formButtons) formButtons.style.display = "none";

        // 요약 카드 표시
        summary.style.display = "block";

        // localStorage에 저장
        const careerData = {
          company: values['회사명'],
          startDate: values['입사년월'],
          endDate: values['퇴사년월'],
          position: values['직무'],
          department: values['근무부서'],
          rank: values['직급'],
          duties: values['담당업무']
        };

        // 기존 데이터 가져오기
        let savedCareers = JSON.parse(localStorage.getItem('careers') || '[]');
        savedCareers.push(careerData);
        localStorage.setItem('careers', JSON.stringify(savedCareers));
      }
      //경력 수정
      function editCareer(button) {
        const entry = button.closest(".career-entry");
        const summary = entry.querySelector(".career-summary");

        // input과 textarea 모두 선택
        const inputs = entry.querySelectorAll("input, textarea");

        // 요약 카드 숨김
        summary.style.display = "none";

        // 모든 입력 필드 다시 보이기
        inputs.forEach(input => input.style.display = "inline-block");

        // 요약 카드 내 버튼 그룹 제거
        const cardButtons = summary.querySelector(".card-buttons");
        if (cardButtons) cardButtons.remove();

        // 저장/취소 버튼 다시 보이게 + 정렬 스타일 적용
        const formButtons = entry.querySelector(".form-buttons");
        if (formButtons) {
          formButtons.style.display = "flex";
          formButtons.style.justifyContent = "flex-end";
          formButtons.style.gap = "8px";
        }
      }

      //경험/활동/교육
      function showExperienceForm() {

        const list = document.getElementById("experience-list");

        // 현재 입력 중인 폼이 있는지 확인 //
        const isFormOpen = Array.from(list.querySelectorAll(".experience-entry")).some(entry => {
          const inputs = entry.querySelectorAll("input, textarea");
          return Array.from(inputs).some(input => input.style.display !== "none");
        });
        if (isFormOpen) {
          return;
        }
        const template = document.getElementById("experience-form-template").firstElementChild;
        const clone = template.cloneNode(true);
        clone.style.display = "block";
        list.appendChild(clone);
      }

      //경험/활동/교육 삭제
      function removeExperienceForm(button) {
        const entry = button.closest(".experience-entry");
        if (entry) {
          entry.remove();
        }
      }
      //경험/활동/교육 저장
      function saveExperience(button) {
        const entry = button.closest(".experience-entry");
        const summary = entry.querySelector(".experience-summary");
        const inputs = entry.querySelectorAll("input, textarea, select");
        const values = {};

        // 입력값 검증
        const startDate = new Date(entry.querySelector('input[placeholder="시작년월"]').value);
        const endDate = new Date(entry.querySelector('input[placeholder="종료년월"]').value);

        if (startDate > endDate) {
          alert('종료년월은 시작년월보다 이후여야 합니다.');
          return;
        }

        // 필수 입력값 검증
        const activityType = entry.querySelector('select').value;
        const place = entry.querySelector('input[placeholder="기관/장소명"]').value;
        const description = entry.querySelector('textarea').value;

        if (!activityType || !place || !description) {
          alert('활동 유형, 기관/장소명, 활동 설명은 필수 입력 항목입니다.');
          return;
        }

        // 값 저장
        inputs.forEach(input => {
          if (input.tagName === 'SELECT') {
            values['활동 유형'] = input.options[input.selectedIndex].text;
          } else {
            values[input.placeholder] = input.value.trim();
          }
        });

        // 날짜 포맷팅
        const formatDate = (dateStr) => {
          if (!dateStr) return '';
          const date = new Date(dateStr);
          return `${date.getFullYear()}.${String(date.getMonth() + 1).padStart(2, '0')}`;
        };

        // 경험 데이터 저장
        const experienceData = {
          activityType: values['활동 유형'],
          place: values['기관/장소명'],
          startDate: values['시작년월'],
          endDate: values['종료년월'],
          description: values['활동 설명']
        };

        // localStorage에서 기존 데이터 가져오기
        let experiences = JSON.parse(localStorage.getItem('experiences') || '[]');
        experiences.push(experienceData);
        localStorage.setItem('experiences', JSON.stringify(experiences));

        summary.innerHTML = `
          <div class="experience-card">
            <h4>${values['활동 유형'] || ''} - ${values['기관/장소명'] || ''} 
                (${formatDate(values['시작년월']) || ''} ~ ${formatDate(values['종료년월']) || ''})</h4>
            <p><strong>활동 설명:</strong> ${values['활동 설명'] || ''}</p>
            <div class="card-buttons" style="display: flex; justify-content: flex-end; gap: 8px;">
              <button onclick="editExperience(this)" class="cencle_save_btn">수정</button>
              <button onclick="removeExperienceForm(this)" class="cencle_save_btn">삭제</button>
            </div>
          </div>
        `;

        // 입력 필드 숨기기
        inputs.forEach(input => input.style.display = "none");

        // 폼 버튼 숨기기
        const formButtons = entry.querySelector(".form-buttons");
        if (formButtons) formButtons.style.display = "none";

        // 요약 카드 표시
        summary.style.display = "block";
      }
      //경험/활동/교육 수정
      function editExperience(button) {
        const entry = button.closest(".experience-entry");
        const summary = entry.querySelector(".experience-summary");

        const inputs = entry.querySelectorAll("input, textarea, select");

        summary.style.display = "none";

        inputs.forEach(input => input.style.display = "inline-block");

        const formButtons = entry.querySelector(".form-buttons");
        if (formButtons) {
          formButtons.style.display = "flex";
          formButtons.style.justifyContent = "flex-end";
          formButtons.style.gap = "8px";
        }
      }


      /* =========================================== 자격/어학/수상 */
      let certificateData = [];
      let certEditIndex = null;
      let editingCardEl = null;

      function showcertificate(isEdit = false) {
        const form = document.getElementById('certificate-form');
        form.style.display = 'block';

        /* 새 항목일 때 완전 초기화 */
        if (!isEdit) {
          certEditIndex = null;
          resetCertForm();   // 드롭다운 초기화
        }

        showCertificateFields();   // 타입별 필드 토글
      }
      function cancelcertificate() {
        document.getElementById('certificate-form').style.display = 'none';

        /* ★ 숨겨둔 카드가 있으면 다시 보이게 */
        if (editingCardEl) {
          editingCardEl.style.display = '';
          editingCardEl = null;
          certEditIndex = null;
        }
        resetCertForm();   // 빈 폼 유지
      }
      function showCertificateFields() {
        const type = document.getElementById('certificateType').value;

        /* (A) 아무 것도 선택하지 않은 상태면 전부 감춤 */
        if (!type) {
          document.querySelectorAll('.cert-fields').forEach(el => el.style.display = 'none');
          return;
        }

        /* (B) 선택값이 있을 때만 해당 블록 보여 줌 */
        document.querySelectorAll('.cert-fields').forEach(el => {
          el.style.display = el.id.startsWith(type) ? 'block' : 'none';
        });
      }
      function savecertificate() {
        const type = document.getElementById('certificateType').value;
        if (!type) { alert('구분을 선택하세요'); return; }

        /* 활성 필드에서 값 수집 */
        const visible = document.querySelector(`#${type}Fields`);
        const obj = { type };
        visible.querySelectorAll('input, select').forEach(el => obj[el.name] = el.value.trim());

        /* 값이 하나라도 비어 있으면 저장 막기(선택) */
        if (Object.values(obj).some(v => v === '')) { alert('모든 항목을 입력하세요'); return; }

        /* 새 항목 vs 수정 항목 구분 */
        if (certEditIndex === null) {
          certificateData.push(obj);
        } else {
          certificateData[certEditIndex] = obj;
        }

        renderCertificateList();      // 리스트 다시 그림
        certEditIndex = null;
        editingCardEl = null;         // ★ 리셋
        resetCertForm();
        cancelcertificate();    // ← 폼 숨김
      }
      function renderCertificateList() {
        const list = document.getElementById('certificate-list');
        list.innerHTML = '';

        certificateData.forEach((it, idx) => {
          /* ① 카드 div */
          const card = document.createElement('div');
          card.className = 'cert-card';

          /* ② 상세 문자열 */
          let detail = '';
          if (it.type === 'license') {
            detail = `<strong>[자격증]</strong> ${it.license_name} · ${it.issuer} (${it.pass_date})`;
          } else if (it.type === 'language') {
            detail = `<strong>[어학]</strong> ${it.lang} ${it.exam} ${it.score} (${it.status})`;
          } else {
            detail = `<strong>[수상]</strong> ${it.award_name} · ${it.host} (${it.award_date})`;
          }

          /* ③ 버튼 묶음 */
          const btnBox = `
      <div class="card-actions" style="display: flex; justify-content: flex-end; gap: 8px;">
        <button class="cencle_save_btn" onclick="editCertificate(${idx})">수정</button>
        <button class="cencle_save_btn" onclick="deleteCertificate(${idx})">삭제</button>
      </div>`;

          /* ④ 카드 완성 & 삽입 */
          card.innerHTML = `<span>${detail}</span>${btnBox}`;
          list.appendChild(card);
        });
      }
      function editCertificate(index) {
        certEditIndex = index;
        const it = certificateData[index];

        /* ① 카드 DOM을 찾아 숨기고 변수에 보관 */
        editingCardEl = document.querySelectorAll('.cert-card')[index];
        if (editingCardEl) editingCardEl.style.display = 'none';

        /* ② 폼 열기 & 값 주입(기존 코드) */
        showcertificate(true);
        document.getElementById('certificateType').value = it.type;
        showCertificateFields();

        if (it.type === 'license') {
          ['license_name', 'issuer', 'pass_date'].forEach(n => document.querySelector(`[name="${n}"]`).value = it[n] || '');
        } else if (it.type === 'language') {
          ['lang', 'exam', 'score', 'status'].forEach(n => document.querySelector(`[name="${n}"]`).value = it[n] || '');
        } else {
          ['award_name', 'award_date', 'host'].forEach(n => document.querySelector(`[name="${n}"]`).value = it[n] || '');
        }
      }
      function deleteCertificate(index) {
        if (confirm('삭제하시겠습니까?')) { certificateData.splice(index, 1); renderCertificateList(); }
      }
      function resetCertForm() {
        const form = document.getElementById('certificate-form');

        /* 드롭다운 첫 번째 값 */
        document.getElementById('certificateType').selectedIndex = 0;

        /* 모든 input 값 제거 */
        form.querySelectorAll('input').forEach(el => el.value = '');

        /* 나머지 select 도 첫 번째 값으로 */
        form.querySelectorAll('select').forEach(el => {
          if (el !== document.getElementById('certificateType')) el.selectedIndex = 0;
        });

        /* 세부 필드 전부 숨김 */
        document.querySelectorAll('.cert-fields').forEach(el => el.style.display = 'none');
      }

      /* ======================================= 취업우대사항 */
      let preferenceData = [];
      let prefEditIndex  = null;
      let prefCardHidden = null;

      /* ① 폼 열기 */
      function showPreference(isEdit=false){
        const form = document.getElementById('preference-form');
        form.style.display='block';

        if(!isEdit){
          prefEditIndex = null;
          resetPrefForm();
        }
        showPreferenceFields();
      }

      /* ② 폼 닫기 */
      function cancelPreference(){
        document.getElementById('preference-form').style.display='none';
        if(prefCardHidden){ prefCardHidden.style.display=''; prefCardHidden=null; }
        prefEditIndex=null;
        resetPrefForm();
      }

      /* ③ 드롭다운에 맞춰 부분 필드 토글 */
      function showPreferenceFields(){
        const type = document.getElementById('preferenceType').value;
        if(!type){
          document.querySelectorAll('.pref-fields').forEach(el=>el.style.display='none');
          return;
        }
        document.querySelectorAll('.pref-fields').forEach(el=>{
          el.style.display = el.id.startsWith(type)?'block':'none';
        });
      }

      /* ④ 저장 */
      function savePreference(){
        const type = document.getElementById('preferenceType').value;
        if(!type){ alert('구분 선택'); return; }

        const visible = document.querySelector(`#${type}Fields`);
        const obj={type};
        visible.querySelectorAll('input,select').forEach(el=>obj[el.name]=el.value.trim());

        if(Object.values(obj).some(v=>v==='')){ alert('모든 항목 입력'); return; }

        (prefEditIndex===null)? preferenceData.push(obj)
                         : preferenceData[prefEditIndex]=obj;


        if(type==='military' && obj.m_status==='served'){
          ['m_start','m_end','m_branch','m_rank','m_reason'].forEach(n=>{
              obj[n] = document.querySelector(`[name="${n}"]`).value.trim();
          });
        }                 
        renderPreferenceList();
        prefEditIndex=null; prefCardHidden=null;
        resetPrefForm(); cancelPreference();
      }

      /* ⑤ 카드 렌더 */
      function renderPreferenceList(){
        const list=document.getElementById('preference-list');
        list.innerHTML='';

        preferenceData.forEach((it,idx)=>{
          let detail='';
          if(it.type==='veteran')    detail=`[보훈] ${it.v_type} (증서: ${it.v_cert})`;
          else if(it.type==='military'){
          if(it.m_status==='served'){
            detail = `[군필] ${it.m_branch}·${it.m_rank} (${it.m_start}~${it.m_end}) / ${it.m_reason}`;
          }else{
            detail = `[병역] ${it.m_status}`;   // 면제·미필
          }
        }
          else detail=`[지원금] ${it.e_type}`;

          const card=document.createElement('div');
          card.className='pref-card';
          card.innerHTML=`
            <span>${detail}</span>
            <div class="card-actions">
              <button class="cencle_save_btn" onclick="editPreference(${idx})">수정</button>
              <button class="cencle_save_btn" onclick="deletePreference(${idx})">삭제</button>
            </div>`;
          list.appendChild(card);
        });
      }

      /* ⑥ 수정 */
      function editPreference(idx){
        prefEditIndex = idx;
        prefCardHidden = document.querySelectorAll('.pref-card')[idx];
        if(prefCardHidden) prefCardHidden.style.display='none';

        const it = preferenceData[idx];
        showPreference(true);

        document.getElementById('preferenceType').value=it.type;
        showPreferenceFields();

        if(it.type==='veteran'){
          document.querySelector('[name="v_type"]').value = it.v_type;
          document.querySelector('[name="v_cert"]').value = it.v_cert;
        }else if(it.type==='military'){
          document.querySelector('[name="m_status"]').value = it.m_status;
        }else{
          document.querySelector('[name="e_type"]').value = it.e_type;
        }
      }   

      /* ⑦ 삭제 */
      function deletePreference(idx){
        if(confirm('삭제하시겠습니까?')){
          preferenceData.splice(idx,1);
          renderPreferenceList();
        }
      }

      /* ⑧ 폼 리셋 */
      function resetPrefForm(){
        const form=document.getElementById('preference-form');
        document.getElementById('preferenceType').selectedIndex=0;
        form.querySelectorAll('input').forEach(el=>el.value='');
        form.querySelectorAll('select').forEach(el=>{
          if(el!==document.getElementById('preferenceType')) el.selectedIndex=0;
        });
        document.querySelectorAll('.pref-fields').forEach(el=>el.style.display='none');
      }

      /* 병역 구분 선택 → 군필 상세 입력 노출 */
      function toggleMilitaryDetail(){
        const val = document.getElementById('mStatus').value;
        document.getElementById('servedDetail').style.display = (val === 'served') ? 'inline-block' : 'none';
      }

      //포트폴리오
      function showPortfolioForm() {
        const list = document.getElementById('portfolio-list');

        // 폼이 실제로 열려 있는지 확인: 입력란이 보이는 entry만
        const isFormOpen = Array.from(list.querySelectorAll('.portfolio-entry')).some(entry => {
          const inputs = entry.querySelectorAll('input, textarea');
          return Array.from(inputs).some(input => input.style.display !== 'none');
        });

        if (isFormOpen) {
          return;
        }

        const template = document.getElementById('portfolio-form-template').firstElementChild;
        const clone = template.cloneNode(true);
        clone.style.display = 'block';
        list.appendChild(clone);
      }
      //포폴 삭제
      function removePortfolioForm(button) {
        const entry = button.closest(".portfolio-entry");
        if (entry) {
          entry.remove();
        }
      }
      //포폴 저장
      function savePortfolio(button) {
        const entry = button.closest(".portfolio-entry");
        const summary = entry.querySelector(".portfolio-summary");

        const inputs = entry.querySelectorAll("input, textarea");
        const fileInput = entry.querySelector(".file-input");

        const values = {};
        inputs.forEach(input => {
          if (input.type !== "file") {
            values[input.placeholder] = input.value;
          }
        });

        // 파일 이름 목록 생성
        const fileNames = [];
        for (let i = 0; i < fileInput.files.length; i++) {
          fileNames.push(fileInput.files[i].name);
        }

        summary.innerHTML = `
        <div class="portfolio-card">
          <h4>${values['프로젝트명'] || ''}</h4>
          <p><strong>설명:</strong> ${values['프로젝트 설명'] || ''}</p>
          ${fileNames.length > 0 ? `<p><strong>첨부파일:</strong> ${fileNames.join(', ')}</p>` : ''}
          <div style="display: flex; justify-content: flex-end; gap: 8px;">
            <button onclick="editPortfolio(this)" class="cencle_save_btn">수정</button>
            <button onclick="removePortfolioForm(this)" class="cencle_save_btn">삭제</button>
          </div>
        </div>
      `;

        if (!values['프로젝트명'] || !values['프로젝트 설명']) {
          alert('프로젝트명, 프로젝트 설명은 필수 입력 항목입니다.');
          return;
        }

        inputs.forEach(input => input.style.display = "none");
        const formButtons = entry.querySelector(".form-buttons");
        if (formButtons) formButtons.style.display = "none";

        summary.style.display = "block";
      }
      //포폴 수정
      function editPortfolio(button) {
        const entry = button.closest(".portfolio-entry");
        const summary = entry.querySelector(".portfolio-summary");

        const inputs = entry.querySelectorAll("input, textarea");
        summary.style.display = "none";

        inputs.forEach(input => input.style.display = "inline-block");

        const formButtons = entry.querySelector(".form-buttons");
        if (formButtons) {
          formButtons.style.display = "flex";
          formButtons.style.justifyContent = "flex-end";
          formButtons.style.gap = "8px";
        }
      }


      //경력기술서
      function showdescription() {
        document.getElementById('career-description-form').style.display = 'block';
      }
      function canceldescription() {
        document.getElementById('career-description-form').style.display = 'none';
        document.getElementById("careerDescriptionText").value = "";
        updateCharCount();
      }
      function updateCharCount() {
        const textArea = document.getElementById("careerDescriptionText");
        if (!textArea) return;  // 텍스트 영역이 아직 없으면 그냥 함수 종료

        const text = textArea.value;
        const total = text.length;
        const noSpace = text.replace(/\s/g, "").length;
        const byteSize = new Blob([text]).size;
        const byteNoSpace = new Blob([text.replace(/\s/g, "")]).size;

        const totalChars = document.getElementById("totalChars");
        const totalBytes = document.getElementById("totalBytes");
        const noSpaceChars = document.getElementById("noSpaceChars");
        const noSpaceBytes = document.getElementById("noSpaceBytes");

        if (totalChars) totalChars.innerText = total;
        if (totalBytes) totalBytes.innerText = byteSize;
        if (noSpaceChars) noSpaceChars.innerText = noSpace;
        if (noSpaceBytes) noSpaceBytes.innerText = byteNoSpace;
      }


      function saveDescription() {
        const text = document.getElementById("careerDescriptionText").value; 

        const summaryContainer = document.createElement("div");
        summaryContainer.className = "career-desc-card";
        summaryContainer.style.border = "1px solid #ddd";
        summaryContainer.style.padding = "10px";
        summaryContainer.style.marginTop = "10px";
        summaryContainer.style.position = "relative";

        summaryContainer.innerHTML = `
          <div style="white-space: pre-wrap;">${text}</div>
          <div style="margin-top: 10px; text-align: right;">
            <button onclick="editDescription(this)" class="cencle_save_btn">수정</button>
            <button onclick="removeDescription(this)" class="cencle_save_btn">삭제</button>
          </div>
        `;

        document.getElementById("career-description-list").appendChild(summaryContainer);

        document.getElementById("careerDescriptionText").value = "";
        document.getElementById("career-description-form").style.display = "none";
        updateCharCount();
      }



      function editDescription(button) {
        const card = button.closest(".career-desc-card");
        if (!card) return;

        const content = card.querySelector("div").innerText;
        document.getElementById("careerDescriptionText").value = content;
        document.getElementById("career-description-form").style.display = "block";

        card.remove();
        updateCharCount();
      }

      function removeDescription(button) {
        const card = button.closest(".career-desc-card");
        if (!card) return;
        card.remove();
      }
      const text = document.getElementById("careerDescriptionText").value;

      const summaryContainer = document.createElement("div");
      summaryContainer.className = "career-desc-card";
      summaryContainer.style.border = "1px solid #ddd";
      summaryContainer.style.padding = "10px";
      summaryContainer.style.marginTop = "10px";
      summaryContainer.style.position = "relative";
      summaryContainer.innerHTML = `
        <div style="white-space: pre-wrap;">${text}</div>
        <div style="margin-top: 10px; text-align: right;">
          <button onclick="editDescription(this)" class="cencle_save_btn">수정</button>
          <button onclick="removeDescription(this)" class="cencle_save_btn">삭제</button>
        </div>
      `;

      document.getElementById("career-description-list").appendChild(summaryContainer);

      // 입력폼 초기화
      document.getElementById("careerDescriptionText").value = "";
      document.getElementById("career-description-form").style.display = "none";
      updateCharCount();

      function insertTemplate(type) {
        const textarea = document.getElementById("careerDescriptionText");
        let content = "";

        switch (type) {
          case "project":
            content =
              `1) 프로젝트명:

    - 연계/소속회사 : (연계/소속회사가 없을 경우, 해당 항목을 지우고 작성하세요)
    - 수행 기간 : YYYY.MM ~ YYYY.MM (약 N개월)
    - 주요 역할 : 화면 설계 및 서비스 기획
    - 업무 성과 :`;
            break;

          case "dev":
            content =
              `1) 프로젝트명:

    - 연계/소속회사 : (연계/소속회사가 없을 경우, 해당 항목을 지우고 작성하세요)
    - 주요 업무 : 백엔드 담당
    - 담당 역할 :
    - 기술 스택 : (운영체제, 개발언어, 데이터베이스 등)
    - 업무 기간 : YYYY.MM ~ YYYY.MM (약 N개월)
    - 개발 인원 :
    - 상세 내용 :`;
            break;

          case "design":
            content =
              `1) 주요 업무 : 콘텐츠 제작

    - 사용 Tool : ex) photoshop
    - 업무기간 : YYYY.MM ~ YYYY.MM (약 N개월)
    - 포트폴리오 URL :
    - 상세내용 :`;
            break;

          case "sales":
            content =
              `1) 프로젝트명:

    - 연계/소속회사 : (연계/소속회사가 없을 경우, 해당 항목을 지우고 작성하세요)
    - 주요 업무 :
    - 수행 기간 : YYYY.MM ~ YYYY.MM (약 N개월)
    - 담당 지역 :
    - 계약 건수 : 월 평균 _건
    - 고객 수 : ex. 인수 30%, 신규개척 70%
    - 상세 내용 :`;
            break;
        }

        textarea.value = content;
        updateCharCount();
      }

      
      //자기소개서
      function collectIntroductionData() {

        const introductionForm = document.getElementById('introduction-form');
        return {
          title: introductionForm.querySelector('input[type="text"]').value,
          content: introductionForm.querySelector('input.longtext').value
        };
      }
      
      function showintroduction() {
        document.getElementById('introduction-form').style.display = 'block';
      }

      function cancelintroduction() {
        document.getElementById('introduction-form').style.display = 'none';
      }

      function saveintroduction() {
        // 저장 로직 구현
        document.getElementById('introduction-form').style.display = 'none';
      }




      window.onload = () => {
        const resumes = JSON.parse(localStorage.getItem('resumeList')) || [];
        resumes.forEach(resume => addToResumeList(resume.basicInfo.title));
      };


    </script>
</body>

</html>